services:
  # MySQL (운영 서버 시뮬레이션: 1GB RAM, 2 vCPU)
  mysql:
    image: mysql:8.0
    container_name: bimillog-mysql-local
    ports:
      - "3307:3306"
    mem_limit: 1g
    cpus: 2.0
    environment:
      - MYSQL_ROOT_PASSWORD=${LOCAL_MYSQL_PASSWORD}
      - MYSQL_DATABASE=bimillogTest
      - MYSQL_CHARACTER_SET_SERVER=utf8mb4
      - MYSQL_COLLATION_SERVER=utf8mb4_unicode_ci
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      - --innodb-buffer-pool-size=512M
      - --max-connections=40
      - --ngram-token-size=2
    volumes:
      - mysql-data-local:/var/lib/mysql
      # 마이그레이션 파일들을 별도 디렉토리에 마운트
      - ./BimilLog_core/src/main/resources/db/migration:/migrations:ro
      # 초기화 스크립트 (알파벳순 실행: 01-init-migrations.sh -> 99-seed.sql)
      - ./local/mysql/init-migrations.sh:/docker-entrypoint-initdb.d/01-init-migrations.sh:ro
      - ./BimilLog_core/src/test/resources/bimillogTest-seed.sql:/docker-entrypoint-initdb.d/99-seed.sql:ro
    networks:
      - bimillog-local
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-p${LOCAL_MYSQL_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis
  redis:
    image: redis:8.2.2-alpine3.22
    container_name: bimillog-redis-local
    ports:
      - "6380:6379"
    mem_limit: 120m
    cpus: 1.0
    command: redis-server --maxmemory 100mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data-local:/data
    networks:
      - bimillog-local
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # Redis Exporter (Prometheus metrics for Redis)
  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: bimillog-redis-exporter-local
    ports:
      - "9121:9121"
    environment:
      - REDIS_ADDR=redis:6379
    networks:
      - bimillog-local
    depends_on:
      - redis

  # Backend (Spring Boot)
  backend:
    build:
      context: ./BimilLog_core
      dockerfile: Dockerfile
    container_name: bimillog-backend-local
    ports:
      - "8080:8080"
    # 운영 서버 시뮬레이션: 1GB RAM, 1 CPU 코어
    mem_limit: 1g
    memswap_limit: 2g
    environment:
      - SPRING_PROFILES_ACTIVE=local
      - SPRING_DATASOURCE_URL=jdbc:mysql://mysql:3306/bimillogTest?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul
      - SPRING_DATASOURCE_USERNAME=root
      - SPRING_DATASOURCE_PASSWORD=${LOCAL_MYSQL_PASSWORD}
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
      # init 스크립트에서 마이그레이션 실행하므로 Flyway 비활성화
      - SPRING_FLYWAY_ENABLED=false
      - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
      - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
      - KAKAO_ADMIN_KEY=${KAKAO_ADMIN_KEY}
      - NAVER_CLIENT_ID=${NAVER_CLIENT_ID}
      - NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}
      - NAVER_REDIRECT_URI=http://localhost:3000/auth/callback/naver
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_REDIRECT_URI=http://localhost:3000/auth/callback/google
      - JWT_SECRET=${JWT_SECRET}
      - MESSAGE_SECRET=${MESSAGE_SECRET}
      - URL=${url}
      # Scouter Java Agent
      - JAVA_TOOL_OPTIONS=-javaagent:/app/scouter/scouter.agent.jar -Dscouter.config=/app/scouter/conf/scouter.conf
    volumes:
      # 로그 디렉토리를 로컬과 동기화 (도커와 인텔리제이 모두 동일 위치에 생성)
      - ./BimilLog_core/logs:/app/logs
      # Scouter Java Agent config
      - ./local/scouter/java-agent.conf:/app/scouter/conf/scouter.conf:ro
    depends_on:
      mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      scouter-collector:
        condition: service_started
    networks:
      - bimillog-local

  # Frontend (Next.js) - Run locally with "npm run dev"
  # frontend:
  #   build:
  #     context: ./BimilLog_front
  #     dockerfile: Dockerfile
  #     args:
  #       NEXT_PUBLIC_API_URL: http://localhost:8080
  #       NEXT_PUBLIC_KAKAO_REDIRECT_URI: http://localhost:3000/auth/callback
  #       NEXT_PUBLIC_KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
  #       NEXT_PUBLIC_KAKAO_JAVA_SCRIPT_KEY: ${NEXT_PUBLIC_KAKAO_JAVA_SCRIPT_KEY}
  #   container_name: bimillog-frontend-local
  #   ports:
  #     - "3000:3000"
  #   depends_on:
  #     - backend
  #   networks:
  #     - bimillog-local
  #   environment:
  #     - NODE_ENV=development

  # Prometheus
  prometheus:
    image: prom/prometheus:latest
    container_name: bimillog-prometheus-local
    ports:
      - "9090:9090"
    volumes:
      - ./BimilLog_core/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data-local:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    depends_on:
      - backend
    networks:
      - bimillog-local

  # Loki (Log Aggregation)
  loki:
    image: grafana/loki:latest
    container_name: bimillog-loki-local
    ports:
      - "3100:3100"
    volumes:
      - loki-data-local:/loki
    networks:
      - bimillog-local
    command: -config.file=/etc/loki/local-config.yaml

  # Promtail (Log Collection)
  promtail:
    image: grafana/promtail:latest
    container_name: bimillog-promtail-local
    volumes:
      - ./local/promtail/promtail-config.yml:/etc/promtail/config.yml
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - bimillog-local
    command: -config.file=/etc/promtail/config.yml
    depends_on:
      - loki

  # Grafana
  grafana:
    image: grafana/grafana:latest
    container_name: bimillog-grafana-local
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=admin
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=http://localhost:3001
    volumes:
      - grafana-data-local:/var/lib/grafana
      - ./local/grafana/datasource.yml:/etc/grafana/provisioning/datasources/datasource.yml
      - ./local/grafana/dashboard-provisioning.yml:/etc/grafana/provisioning/dashboards/dashboard-provisioning.yml
      - ./local/grafana/dashboards:/etc/grafana/provisioning/dashboards/json
    depends_on:
      - prometheus
      - loki
      - redis-exporter
    networks:
      - bimillog-local

  # Scouter Collector (APM Server)
  scouter-collector:
    image: scouterapm/scouter-server:2.17.1
    container_name: bimillog-scouter-collector
    ports:
      - "6100:6100/tcp"
      - "6100:6100/udp"
    volumes:
      - ./local/scouter/collector.conf:/opt/scouter-server/conf/scouter.conf
      - scouter-data-local:/scouter-data
    networks:
      - bimillog-local

  # Scouter Host Agent (OS Monitoring)
  scouter-host-agent:
    image: amazoncorretto:21-alpine-jdk
    container_name: bimillog-scouter-host-agent
    entrypoint: ["/bin/sh", "-c"]
    command:
      - |
        wget -q "https://github.com/scouter-project/scouter/releases/download/v2.21.1/scouter-all-2.21.1.tar.gz" -O /tmp/scouter.tar.gz &&
        tar -xzf /tmp/scouter.tar.gz -C /tmp &&
        cp /tmp/scouter/agent.host/conf/scouter.conf /tmp/scouter/agent.host/conf/scouter.conf.bak &&
        cp /host-conf/scouter.conf /tmp/scouter/agent.host/conf/scouter.conf &&
        java -cp "/tmp/scouter/agent.host/scouter.host.jar" scouter.boot.Boot /tmp/scouter/agent.host
    volumes:
      - ./local/scouter/host-agent.conf:/host-conf/scouter.conf:ro
    depends_on:
      - scouter-collector
    networks:
      - bimillog-local
    restart: unless-stopped

  # JMeter (Load Testing)
  jmeter:
    image: justb4/jmeter:latest
    container_name: bimillog-jmeter-local
    profiles:
      - loadtest
    volumes:
      - ./performance/jmeter:/tests
      - ./performance/results:/results
    networks:
      - bimillog-local
    depends_on:
      - backend
    command: >
      -n -t /tests/cache-load-test.jmx -l /results/cache-load.jtl -e -o /results/report

networks:
  bimillog-local:
    driver: bridge

volumes:
  mysql-data-local:
  redis-data-local:
  prometheus-data-local:
  grafana-data-local:
  scouter-data-local:
  loki-data-local:
