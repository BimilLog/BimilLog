<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- í”„ë¡œíŒŒì¼ë³„ CloudWatch ì„¤ì • (ìš´ì˜í™˜ê²½ë§Œ) -->
    <springProfile name="prod | production">
        <property name="LOG_GROUP" value="/bimillog/application"/>
        <property name="LOG_STREAM" value="bimillog-${HOSTNAME:-localhost}-${PID:-unknown}"/>
        <property name="AWS_REGION" value="ap-northeast-2"/>
    </springProfile>

    <!-- ì½˜ì†” ì¶œë ¥ appender -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{40} - %msg%n%xException</pattern>
        </encoder>
    </appender>

    <!-- íŒŒì¼ ì¶œë ¥ appender -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/application.log</file>
        <encoder>
            <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{40} - %msg%n%xException</pattern>
        </encoder>
        <rollingPolicy class="ch.qos.logback.core.rolling.SizeAndTimeBasedRollingPolicy">
            <fileNamePattern>logs/application-%d{yyyy-MM-dd}.%i.log</fileNamePattern>
            <maxFileSize>50MB</maxFileSize>
            <maxHistory>30</maxHistory>
            <totalSizeCap>2GB</totalSizeCap>
        </rollingPolicy>
    </appender>

    <!-- ðŸ”´ ìš´ì˜í™˜ê²½ì—ì„œë§Œ AWS CloudWatch Logs appender -->
    <springProfile name="prod | production">
        <appender name="CLOUDWATCH" class="ca.pjer.logback.AwsLogsAppender">
            <logGroupName>${LOG_GROUP}</logGroupName>
            <logStreamUuidPrefix>${LOG_STREAM}-</logStreamUuidPrefix>
            <logRegion>${AWS_REGION}</logRegion>
            
            <layout>
                <pattern>%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{40} - %msg%n%xException</pattern>
            </layout>
            
            <maxBatchLogEvents>50</maxBatchLogEvents>
            <maxFlushTimeMillis>10000</maxFlushTimeMillis>
            <maxBlockTimeMillis>5000</maxBlockTimeMillis>
            <createLogGroup>true</createLogGroup>
            <createLogStream>true</createLogStream>
            <retentionTimeDays>30</retentionTimeDays>
            
            <!-- INFO ë ˆë²¨ ì´ìƒë§Œ CloudWatchë¡œ ì „ì†¡ -->
            <filter class="ch.qos.logback.classic.filter.ThresholdFilter">
                <level>INFO</level>
            </filter>
        </appender>

        <!-- ë¹„ë™ê¸° CloudWatch Appender -->
        <appender name="ASYNC_CLOUDWATCH" class="ch.qos.logback.classic.AsyncAppender">
            <appender-ref ref="CLOUDWATCH"/>
            <queueSize>1024</queueSize>
            <discardingThreshold>20</discardingThreshold>
            <includeCallerData>false</includeCallerData>
        </appender>
    </springProfile>

    <!-- ðŸŸ¢ ê°œë°œí™˜ê²½ ë¡œê±° ì„¤ì • -->
    <springProfile name="!prod &amp; !production">
        <!-- ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê±° (DEBUG) -->
        <logger name="jaeik.bimillog" level="INFO" additivity="false">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
        </logger>

        <!-- HTTP ìš”ì²­ ë¡œê±° (DEBUG) -->
        <logger name="jaeik.bimillog.global.filter.LogFilter" level="DEBUG" additivity="false">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
        </logger>

        <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ -->
        <logger name="com.zaxxer.hikari" level="INFO"/>
        <logger name="org.springframework.security" level="DEBUG"/>
        <logger name="org.springframework.web" level="DEBUG"/>
        
        <!-- JPA ì¿¼ë¦¬ ë¡œê·¸ (ê°œë°œí™˜ê²½ì—ì„œë§Œ) -->
        <logger name="org.hibernate.SQL" level="INFO"/>
        <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="TRACE"/>
        <logger name="org.springframework.orm.jpa" level="DEBUG"/>

        <!-- JdbcTemplate SQL ë¡œê·¸ -->
        <logger name="org.springframework.jdbc.core.JdbcTemplate" level="DEBUG"/>
        <logger name="org.springframework.jdbc.core.StatementCreatorUtils" level="TRACE"/>

        <!-- ë£¨íŠ¸ ë¡œê±°  -->
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
        </root>
    </springProfile>

    <!-- ìš´ì˜í™˜ê²½ ë¡œê±° ì„¤ì • (INFO ë ˆë²¨) -->
    <springProfile name="prod | production">
        <!-- ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê±° (INFO) -->
        <logger name="jaeik.bimillog" level="INFO" additivity="false">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
            <appender-ref ref="ASYNC_CLOUDWATCH"/>
        </logger>

        <!-- HTTP ìš”ì²­ ë¡œê±° (INFO) -->
        <logger name="jaeik.bimillog.global.filter.LogFilter" level="INFO" additivity="false">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
            <appender-ref ref="ASYNC_CLOUDWATCH"/>
        </logger>

        <!-- ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë“¤ (ìš´ì˜í™˜ê²½ì—ì„œëŠ” ê²½ê³ ë§Œ) -->
        <logger name="com.zaxxer.hikari" level="WARN"/>
        <logger name="org.springframework.security" level="WARN"/>
        <logger name="org.springframework.web" level="WARN"/>
        
        <!-- JPA ì¿¼ë¦¬ ë¡œê·¸ ë¹„í™œì„±í™” (ìš´ì˜í™˜ê²½) -->
        <logger name="org.hibernate.SQL" level="WARN"/>
        <logger name="org.hibernate.type.descriptor.sql.BasicBinder" level="WARN"/>
        <logger name="org.springframework.orm.jpa" level="WARN"/>

        <!-- JdbcTemplate SQL ë¡œê·¸ ë¹„í™œì„±í™” -->
        <logger name="org.springframework.jdbc.core.JdbcTemplate" level="WARN"/>
        <logger name="org.springframework.jdbc.core.StatementCreatorUtils" level="WARN"/>

        <!-- ë£¨íŠ¸ ë¡œê±° (ìš´ì˜í™˜ê²½: INFO) -->
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
            <appender-ref ref="FILE"/>
            <appender-ref ref="ASYNC_CLOUDWATCH"/>
        </root>
    </springProfile>
</configuration> 