version: '3.8'

services:
  backend:
    image: jaeikjeong/bimillog:backend
    container_name: bimillog-backend
    ports:
      - "8080:8080"
    networks:
      - bimillog-network
    volumes:
      - /home/ubuntu/logs:/app/logs
      - /home/ubuntu/scouter/agent.java:/app/scouter-agent
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - PROD_MYSQL_URL=${PROD_MYSQL_URL}
      - PROD_MYSQL_USERNAME=${PROD_MYSQL_USERNAME}
      - PROD_MYSQL_PASSWORD=${PROD_MYSQL_PASSWORD}
      - PROD_REDIS_HOST=${PROD_REDIS_HOST}
      - PROD_REDIS_PORT=${PROD_REDIS_PORT}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - KAKAO_CLIENT_ID=${KAKAO_CLIENT_ID}
      - KAKAO_CLIENT_SECRET=${KAKAO_CLIENT_SECRET}
      - KAKAO_ADMIN_KEY=${KAKAO_ADMIN_KEY}
      - JWT_SECRET=${JWT_SECRET}
      - MESSAGE_SECRET=${MESSAGE_SECRET}
      - PROD_KAKAO_REDIRECT_URL=${PROD_KAKAO_REDIRECT_URL}
      - NAVER_CLIENT_ID=${NAVER_CLIENT_ID}
      - NAVER_CLIENT_SECRET=${NAVER_CLIENT_SECRET}
      - PROD_NAVER_REDIRECT_URL=${PROD_NAVER_REDIRECT_URL}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - PROD_GOOGLE_REDIRECT_URL=${PROD_GOOGLE_REDIRECT_URL}
      - PROD_SERVER_SSE_URL=${PROD_SERVER_SSE_URL}
      - PROD_SERVER_PORT=${PROD_SERVER_PORT}
      - PROD_FLYWAY_LOCATIONS=${PROD_FLYWAY_LOCATIONS}

    depends_on:
      - redis
    restart: unless-stopped

  redis:
    image: redis:8.2.2-alpine3.22
    container_name: bimillog-redis
    ports:
      - "6379:6379"
    networks:
      - bimillog-network
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD}
      --appendonly yes
      --appendfsync everysec
    volumes:
      - redis-data:/data
    restart: unless-stopped

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: bimillog-redis-exporter
    ports:
      - "9121:9121"
    networks:
      - bimillog-network
    environment:
      - REDIS_ADDR=redis:6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    depends_on:
      - redis
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: bimillog-prometheus
    ports:
      - "9090:9090"  # VPC 내부 접근 허용 (Security Group으로 제어)
    networks:
      - bimillog-network
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    restart: unless-stopped

  node-exporter:
    image: prom/node-exporter:latest
    container_name: bimillog-node-exporter
    ports:
      - "9100:9100"  # VPC 내부 접근 허용
    networks:
      - bimillog-network
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    restart: unless-stopped

networks:
  bimillog-network:
    driver: bridge

volumes:
  redis-data:
  prometheus-data:
